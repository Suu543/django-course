# Setting Up the Database
- Creating Migrations
- Running Migrations
- Reversing Migrations
- Populating the Database

## Supported Database Engines
- SQLite (Very Basic Lightweight)
- PostgreS1L
- MySQL (Most Common in Django Community)
- MariaDB (Most Common in Django Community)
- Oracle
- MS SQL Serer

## Creating Migrations
```python
python manage.py makemigrations

Migrations for 'store':
  store\migrations\0001_initial.py
    - Create model Cart
    - Create model Collection
    - Create model Customer
    - Create model Order
    - Create model Promotion
    - Create model Product
    - Create model OrderItem
    - Add field featured_product to collection
    - Create model CartItem
    - Create model Address
Migrations for 'likes':
  likes\migrations\0001_initial.py
    - Create model LikedItem
Migrations for 'tags':
  tags\migrations\0001_initial.py
    - Create model Tag
    - Create model TaggedItem
(storefront)
```

폴더를 찾아 들어가보면, `Primary Key`등 `Django`가 자동으로 생성한 것을 확인할 수 있다.
1. Ctrl + P
2. #Product
3. `Product` 클래스의 `price`를 `unit_price`로 이름변경 
4. python manage.py makemigrations
- Did you rename product.price to product.unit_price? Yes
5. 두번째 migration이 생성된 것을 확인할 수 있다.
6. migrations ==> 0002_rename_price_product_unit_price.py ==> 0002_rename_price_to_unit_price.py (이름 변경)
7. python manage.py makemigrations
- 어떤 변경 사항도 없는 경우 아래와 같이 메시지가 출력됨
- No changes detected

```python
# store ==> models.py ==> Product
class Product(models.Model):
    title = models.CharField(max_length=255)  # varchar(255)
    slug = models.SlugField()
    description = models.TextField()
    unit_price = models.DecimalField(max_digits=6, decimal_places=2)  # 9999.99
    inventory = models.IntegerField()
    last_update = models.DateTimeField(auto_now=True)
    collection = models.ForeignKey(Collection, on_delete=models.PROTECT)
    promotions = models.ManyToManyField(Promotion)

python manage.py makemigrations

'''
You are trying to add a non-nullable field 'slug' to product without a default; we can't do that (the database needs something to populate existing rows).
Please select a fix:
 1) Provide a one-off default now (will be set on all existing rows with a null value for this column)
 2) Quit, and let me add a default in models.py
Select an option: 2

- null or default 값을 입력해야함

1번 옵션을 선택한 경우 '-' 입력
'''

- `default` 값을 추가하고 `store app`의 `migrations` 파일에 들어가 보면 아래와 같이 기본값이 추가된 것을 확인할 수 있다. 

```python
# Generated by Django 4.0.2 on 2022-02-15 07:10

from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('store', '0002_product_slug'),
    ]

    operations = [
        migrations.AlterField(
            model_name='product',
            name='slug',
            field=models.SlugField(default='-'),
            preserve_default=False,
        ),
    ]
```

```python
class Product(models.Model):
    title = models.CharField(max_length=255)  # varchar(255)
    slug = models.SlugField(null=True, default="-")
    description = models.TextField()
    unit_price = models.DecimalField(max_digits=6, decimal_places=2)  # 9999.99
    inventory = models.IntegerField()
    last_update = models.DateTimeField(auto_now=True)
    collection = models.ForeignKey(Collection, on_delete=models.PROTECT)
    promotions = models.ManyToManyField(Promotion)
```

- `0003_alter_product_slug.py` ==> `0003_add_slug_to_product.py`로 변경하기

## Running Migrations
- `migration`을 만들었다면, 프로젝트에 반영해 보자.
- 각 `migration`은 `git`을 비유해 표현하자면 하나의 `commit`으로 간주할 수 있다.

```python
python manage.py migrate
```
 
- 1. `SQLite` 확장 프로그램 설치하기
- 2. `db.sqlite3` 파일에 내용이 반영된 것을 확인할 수 있다.
- 3. View ==> Command Palette ==> SQLite: Open Database ==> EXPLORER 탭에 SQLITE EXPLORER가 생성된 것을 확인할 수 있다.
- 4. `django_migrations` 파일을 확인해 보면 `migrations` 기록이 작성된 것을 확인할 수 있다.

```python
# 0003 파일을 내부적으로 SQL Language Query 문을 보여준다.
python manage.py sqlmigrate store 0003
```

### Exercise
1. Add zip to Address
2. Create a migration
3. Run it
4. Inspect the migrations table

## Customizing Database Schema
- https://docs.djangoproject.com/en/4.0/ref/models/options/
- https://wikidocs.net/6667

```python
class Customer(models.Model):
   ...

    class Meta:
        db_table = "store_customers"
        indexes = [
            models.Index(fields=['last_name', 'first_name'])
        ]

python manage.py makemigrations
python manage.py migrate
```

## Reverting Migrations
1. db_table 이름이 마음에 들지 않은 경우 이를 지우고 다시 migration을 만들고 migrate 하는 방법
```python
    class Meta:
        # db_table = "store_customers"
        indexes = [
            models.Index(fields=['last_name', 'first_name'])
        ]        
```

2. 0004 ==> 0003
```python
# Downgrade
python manage.py migrate store 0003
```

3. `models.py`에서 실제 코드 삭제, `migrations`에서 파일 삭제 두 과정을 모두 해야 함

4. `git`을 사용하는 방법
```python
git log --oneline
git reset --hard HEAD~1
```
### Exercise
```python
Customer
    first_name ==> given_name
```

## Installing MySQL
1. https://www.mysql.com/
2. https://www.mysql.com/downloads/
3. https://dev.mysql.com/downloads/
4. MySQL Community Server

## Connecting to MySQL
MYSQL CLIENTS
- MySQL Workbench (Free)
- TablePlus ($59)
- DataGrip ($89)

```python
# MySQL WorkBench
CREATE DATABASE storefront
```

## Using MySQL in Django
설정하는 시점에 오류가 발생할 것이다. 이는 매우 자연스러운 동작이기 때문에 쭉 진행하면된다.
`Stackoverflow` 등의 사이트를 참고해 해결해보는 것을 추천한다.

- Error: mysql command not found
- Causes: 
  - MySQL not installed properly
  - MySQL is not in the PATH

```python
pipenv install mysqlclient

mysql -u root -p
```

```python
# storefront ==> settings.py
# 기본 DB 설정을 변경해보자

# Before
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}

# After
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.mysql',
        'NAME': 'storefront',
        'HOST': 'localhost',
        'USER': 'root',
        # 이 부분은 production에서는 숨길 것이다.
        'PASSWORD': 'MYPASSWORD'
    }
}


python manage.py runserver
python manage.py migrate

# MySQL Workbench를 확인해 보면 Schemas에 등록된 것을 확인할 수 있다.
```
## Running Custom SQL
```python
python manage.py makemigrations store --empty

# 0005_auto_...
# 아래와 같이 빈 내용(operations)이 있는 것을 확인할 수 있다.
# Generated by Django 4.0.2 on 2022-02-15 11:04

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ('store', '0004_customer_store_custo_last_na_e6a359_idx_and_more'),
    ]

    operations = [
        migrations.RunSQL("""
            INSERT INTO store_collection (title)
            VALUES ("collection1")
        """, """
            DELETE FROM store_collection
            WHERE title="collection1"
        """)
    ]

python manage.py migrate

# MySQL Workbench를 확인해 보면 collection1이 추가된 것을 확인할 수 있다

# downgrade를 원하는 경우 ==> 실행시 collection1이 제거된 것을 확인할 수 있다.
python manage.py migrate store 0003
```

## Generating Dummy Data
- https://www.mockaroo.com/

<img src="https://cdn-images-1.medium.com/max/800/1*ZNB_s_49AD4M2qhId-VGyA.png" />

- 1. Download Data 클릭
- 2. MySQL Workbench에 Drag and Drop 하기
- https://www.google.com/search?q=mysql+workbench+execute+all+statements&oq=mysql+workbench+execute+all&aqs=chrome.1.69i57j0i512.8161j0j7&sourceid=chrome&ie=UTF-8

- 아래와 같이 `query` 작성
```sql
SELECT COUNT(*) FROM store_customers
```

